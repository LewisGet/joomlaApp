EasyBlog.module("dashboard/media.mini",function(e){var t=this;EasyBlog.require().library("throttle-debounce","ui/position","dialog").view("dashboard/media.mini","dashboard/media.mini.item").language("COM_EASYBLOG_MM_CONFIRM_DELETE_ITEM","COM_EASYBLOG_MM_CANCEL_BUTTON","COM_EASYBLOG_MM_YES_BUTTON","COM_EASYBLOG_MM_ITEM_DELETE_CONFIRMATION","COM_EASYBLOG_LOADING","COM_EASYBLOG_DELETING").done(function(){EasyBlog.Controller("Dashboard.Media.Mini",{defaultOptions:{view:{body:"dashboard/media.mini",item:"dashboard/media.mini.item"},places:[],uploader:"",items:undefined,"{itemLoader}":".placeItem .loader","{emptyList}":".nothing","{headerTitle}":".headerTitle","{uploadButton}":".uploadButton","{openMediaManagerButton}":".openMediaManagerButton","{openMediaManagerButtonContainer}":".openMediaManagerButtonContainer","{header}":".browserHeader","{content}":".browserContent","{messageGroup}":".browserMessageGroup","{message}":".browserMessage","{itemGroup}":".browserItemGroup","{item}":".browserItem","{removeItemButton}":".removeItemButton"}},function(t){return{init:function(){EasyBlog.dashboard.media.registerManager(t),t.element.append(t.view.body({showUploadButton:t.options.uploader==""?!1:!0})),t.options.showMediaManagerButton&&t.openMediaManagerButtonContainer().show(),t.setLayout(),t._bind(t.content(),"scroll",e.debounce(500,t.setItemLayout)),t.threadLimit=t.options.threadLimit,t.retrieveItems(),t.initUploader()},"{window} resize":function(){t.setItemLayout()},initUploader:function(){t.uploadButton().css("opacity",0),EasyBlog.require().script("dashboard/media.mini.uploader").done(function(){t.uploader=new EasyBlog.Controller.Dashboard.Media.Mini.Uploader(t.element,{controller:{browser:t},settings:t.options.uploader}),t.uploadButton().css("opacity",1);try{t.uploader.refresh()}catch(e){}})},setLayout:function(){var e=t.element.height()-t.header().outerHeight()-(t.content().outerHeight()-t.content().height());t.content().height(e),t.messageGroup().height(e);try{t.uploader.refresh()}catch(n){}},setItemLayout:function(){var e=96,n=t.itemGroup().width(),r=Math.floor(n/e),i=Math.floor(n/r);t.item().width(i).height(i).trigger("setLayout")},setTitle:function(e){var n=t.headerTitle();n.html(e)},retrieveItems:function(){t.content().addClass("busy");var n=[],r=[];e.each(t.options.places,function(e,t){r.push(t)});var i=function(){var s=EasyBlog.dashboard.media,o=r.shift(),u={beforeSend:function(){t.setTitle(e.language("COM_EASYBLOG_LOADING")+" "+o.title+"...")},success:function(t){e.each(t,function(e,t){t.place=o.id}),s.items[o.id]=t,n=n.concat(t)},complete:function(){r.length<1?(t.setTitle(""),t.content().removeClass("busy"),t.populate(n)):i()}},a=s.items[o.id];a?(n=n.concat(a),u.complete()):EasyBlog.ajax("site.views.media.listImages",{place:o.id,variation:!1},u)};i()},items:{},itemByPath:{},populate:function(n){t.itemGroup().empty();if(n.length<1){t.showMessage("noImages");return}e.each(n,function(e,n){var r=t.createItem(n);r.element.appendTo(t.itemGroup())}),setTimeout(t.setItemLayout,100)},createItem:function(n){var r={id:n.id||e.uid("item-"),meta:n,element:t.view.item({item:n})};return t.items[r.id]=r,t.itemByPath[r.meta.place+r.meta.path]=r,r.element.data("item",r),r},addItem:function(n){var r=!1;e.each(t.options.places,function(e,t){t.id===n.place&&(r=!0)});if(!r)return;t.hideMessage();var i=t.createItem(n);i.element.prependTo(t.itemGroup()),t.setItemLayout()},removeItem:function(e){var n=t.itemByPath[e.place+e.path];if(n===undefined)return;n.element.remove(),delete t.items[n.id],delete t.itemByPath[e.place+e.path]},removeItemDialog:function(n){e.dialog({title:e.language("COM_EASYBLOG_MM_CONFIRM_DELETE_ITEM"),content:"<div style='font-size: 12px'>"+e.language("COM_EASYBLOG_MM_ITEM_DELETE_CONFIRMATION")+n.meta.title+"?</div>",showOverlay:!1,body:{css:{minWidth:200,minHeight:100}},buttons:[{name:e.language("COM_EASYBLOG_MM_CANCEL_BUTTON"),click:function(){e.dialog().close()}},{name:e.language("COM_EASYBLOG_MM_YES_BUTTON"),click:function(){EasyBlog.ajax("site.views.media.delete",{place:n.meta.place,path:n.meta.path},{beforeSend:function(){t.element.addClass("uploading"),t.setTitle(e.language("COM_EASYBLOG_DELETING")+" "+n.meta.title+"..."),n.element.find(".itemIcon").css("opacity",.3)},complete:function(){t.element.removeClass("uploading"),t.setTitle(""),t.removeItem(n.meta)},fail:function(e){console.error(e)}}),e.dialog().close()}}]})},"{removeItemButton} click":function(e,n){n.stopPropagation();var r=e.parents(".browserItem").data("item");if(r===undefined)return;t.removeItemDialog(r)},"{item} mouseenter":function(e,t){if(!e.hasClass("hasIcon"))return;var n=e.find(".itemIcon"),r=e.find(".removeItemButton");r.css({top:parseInt(n.css("top"))-8,left:parseInt(n.css("left"))+parseInt(n.css("width"))-8}).show()},"{item} mouseleave":function(e,t){e.find(".removeItemButton").hide()},isVisible:function(e){var n=t.content(),r=e.outerHeight(),i=e.offset().top,s=i+r,o=n.offset().top,u=o+n.height();return!(i<o&&s<o||i>u&&s>u)},resizeWithin:function(e,t,n,r){var i=e,s=t,o=n/e;i=e*o,s=t*o;if(s>r){var o=r/t;i=e*o,s=t*o}return{width:i,height:s}},tasks:[],threads:0,threadLimit:8,addTask:function(e){t.tasks.push(e),t.runTask()},runTask:function(){if(t.tasks.length>0&&t.threads<t.threadLimit){t.threads++;var n=t.tasks.shift(),r=e.Deferred();n.apply(r),r.always(function(){t.threads--,t.runTask()}),t.runTask()}},"{item} setLayout":function(e,n){var r=e.data("item"),i=e.find(".itemIcon");if(!i.data("loaded")){if(i.data("loading"))return;t.addTask(function(){var n=this;t.isVisible(e)||n.reject();var s=r.meta.icon.url;i.data("useNaturalUrl")||(s=EasyBlog.baseUrl+"&view=media&layout=getIconImage&place="+encodeURIComponent(r.meta.place)+"&path="+encodeURIComponent(r.meta.path)+"&format=image&tmpl=component"),i.load(function(){i.data("loaded",!0),i.data("loading",!1),r.element.addClass("hasIcon"),e.trigger("setLayout"),n.resolve()}).error(function(){i.data("loaded",!1),i.data("loading",!1),i.data("triedNaturalUrl")||(i.data("useNaturalUrl",!0),i.data("triedNaturalUrl",!0),e.trigger("setLayout")),n.reject()}).css({opacity:0}).attr("src",s)})}var s=8,o=e.width(),u=e.height(),a=t.resizeWithin(i.width(),i.height(),o-s,u-s);i.css({width:a.width,height:a.height,top:(u-a.height)/2,left:(o-a.width)/2,opacity:1})},"{self} mouseleave":function(){if(t.element.hasClass("uploading"))return;t.setTitle("")},"{item} mouseover":function(n){if(t.element.hasClass("uploading"))return;var r=e(n).data("item");t.setTitle(r.meta.title)},"{item} dragstart":function(e){return!1},"{item} click":function(n){if(!n.hasClass("hasIcon"))return;var r=e(n).data("item"),i=e(n).find(".itemIcon"),s=t.options.insert;if(s&&s.call(null,r)===!1)return;var o=e("<img>").attr("src",r.meta.thumbnail.url);if(t.options.enforceImageDimension){var u=t.resizeWithin(i.width(),i.height(),t.options.enforceImageWidth,t.options.enforceImageHeight);o.attr({width:Math.floor(u.width),height:Math.floor(u.height)})}t.options.useLightbox&&(o=e("<a>").addClass("easyblog-thumb-preview").attr({href:r.meta.url,title:r.meta.title}).html(o)),EasyBlog.dashboard.editor.insert(o.toHTML())},"{openMediaManagerButton} click":function(e){var t=EasyBlog.dashboard.media;t.modal===undefined?(e.addClass("busy"),t.loadManager(function(){e.removeClass("busy")})):t.showManager()},showMessage:function(e,n){n===undefined&&(n=!1),t.content().css({overflowY:"hidden"})[0].scrollTop=0;var r=t.messageGroup(),i=t.message("."+e);i.length>0&&(t.message().hide(),r.toggleClass("withOverlay",n).show(),i.css({opacity:0}).show().position({my:"center center",at:"center center",of:r}).css({opacity:1}))},hideMessage:function(){t.content().css({overflowY:"scroll"}),t.messageGroup().hide(),t.message().hide(),t.setItemLayout()}}}),t.resolve()})});