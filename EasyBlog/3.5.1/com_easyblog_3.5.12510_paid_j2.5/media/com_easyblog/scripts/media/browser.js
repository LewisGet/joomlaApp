EasyBlog.module("media/browser",function(e){var t=this;EasyBlog.require().library("easing","scrollTo").script("media/browser.item","media/browser.item.folder","media/browser.title","media/browser.search","media/browser.navigation").view("media/browser.item","media/browser.treeitem").done(function(){EasyBlog.Controller("Media.Browser",{defaultOptions:{view:{item:"media/browser.item",treeItem:"media/browser.treeitem"},directorySeparator:"/",path:"",items:undefined,title:"",viewMode:"tile","{header}":".browserHeader","{content}":".browserContent","{footer}":".browserFooter","{treeToggleButton}":".browserTreeToggleButton","{tileViewButton}":".browserTileViewButton","{listViewButton}":".browserListViewButton","{treeItemGroup}":".browserTreeItemGroup","{treeItem}":".browserTreeItem","{itemGroup}":".browserItemGroup","{item}":".browserItem","{headerTitle}":".browserTitle","{headerSearch}":".browserSearch","{headerNavigation}":".browserNavigation","{headerUpload}":".browserUploadButton","{dashboardButton}":".browserDashboardButton","{footerStatus}":".browserStatus","{footerMessage}":".browserMessage"}},function(t){return{init:function(){t.threadLimit=t.media.options.threadLimit,t.options.directorySeparator=t.media.options.directorySeparator,t.baseFolder=t.options.title,t.headerNavigation().implement(EasyBlog.Controller.Media.Browser.Navigation,{controller:t.controllerProps(),path:t.options.path,baseFolder:t.baseFolder}),t.element.implement(EasyBlog.Controller.Media.Browser.Title,{controller:t.controllerProps()}).implement(EasyBlog.Controller.Media.Browser.Search,{controller:t.controllerProps()}),t.initUploader(),t.viewMode(t.options.viewMode),t.setLayout(),t.populate(),t._bind(t.itemGroup(),"scroll",e.debounce(250,t["{itemGroup} scroll"]))},controllerProps:function(n){return e.extend({media:t.media,place:t.place,browser:t},n||{})},initUploader:function(){t.place.acl().canUploadItem&&EasyBlog.require().script("media/browser.uploader").done(function(){t.uploader=new EasyBlog.Controller.Media.Browser.Uploader(t.element,{controller:t.controllerProps(),settings:t.options.uploader}),t.setLayout()})},setLayout:function(){t.setLayout.seed=e.uid();var n=t.place.browserViewport().height(),r=n-t.header().outerHeight()-t.footer().outerHeight();t.treeItemGroup().height(r),t.itemGroup().height(r),t.headerTitle().width(t.header().width()-Math.abs(t.headerSearch().position().left+t.headerSearch().outerWidth()-t.headerUpload().position().left)-4),t.setItemLayout(),t.trigger("setLayout")},items:{},itemByPath:{},populate:function(n){t.itemGroup().addClass("busy");if(t.populated)return;n=n||t.options.items;if(n===undefined){t.loadItems({success:function(e){t.populate(e)},fail:function(){try{console.error(message)}catch(e){}}});return}var r;e.isArray(n)?e.each(n,function(e,n){if(n.type=="folder"){var n=t.createFolder(n);e==0&&(r=n)}}):r=t.createFolder(n),t.populated=!0,r.initialization.done(function(){t.itemGroup().removeClass("busy"),t.focusItem(r),t.setItemLayout()})},loadItems:function(e){var n=t.options.path;return EasyBlog.ajax("site.views.media.listItems",{place:t.place.id,path:t.options.path,variation:!1},e)},addItem:function(e){if(t.itemByPath[e.path])return;var n=t.options.directorySeparator,r=e.path.substr(0,e.path.lastIndexOf(n)),i=t.itemByPath[r||n];t.createItem(e,i)},createItem:function(n,r){var i=n.id||e.uid("item-"),s=new EasyBlog.Controller.Media.Browser.Item(t.view.item(),{controller:t.controllerProps({id:i,meta:n,parentFolder:r})});return r&&s.meta.type!=="folder"&&r.handler.addItem(s),t.items[s.id]=s,t.itemByPath[s.meta.path]=s,s},createFolder:function(e,n){var r=t.createItem(e,n);return r.tree=t.createTreeItem(r),n?(r.tree.insertAfter(n.tree),r.element.insertAfter(n.element),n.handler.folders.push(r)):(r.tree.appendTo(t.treeItemGroup()),r.element.appendTo(t.itemGroup())),r.handlerInitialization.done(function(){r.handler.populateFolderContents()}),r},removeItemByPath:function(e,n){var r=t.itemByPath(e);t.removeItem(r,n)},removeItem:function(n,r){typeof n!="object"&&(n=t.items[n]);if(!n)return;n.meta.type=="folder"&&(e.each(n.handler.folders,function(e,n){t.removeItem(n,!0)}),e.each(n.handler.items,function(e,n){t.removeItem(n,!0)}));if(n.meta.type=="image"){n.meta.place=t.place.id;var i=t.media.dashboard;i&&i.media.removeItem(n.meta)}if(n.meta.path===t.options.directorySeparator){n.element.addClass("empty");return}n.tree&&n.tree.slideUp(function(){n.tree.remove()}),n.panel&&n.panel.remove(),n.remove(),delete t.itemByPath[n.meta.path],delete t.items[n.id],r||n.parentFolder&&t.focusItem(n.parentFolder)},focusItem:function(e){if(e===undefined)return;var e=t.currentItem(e);if(e===undefined)return;e.element.removeClass("active"),t.scrollTo(e)},activateItem:function(e){if(e===undefined)return;t.currentItem(e),e.activate(),t.trigger("itemActivate",[t,e])},currentItem:function(e){var n=t.currentItem.item;n&&n._destroyed&&(n=t.currentItem.item=undefined),typeof e=="string"&&(e=t.itemByPath[e]);if(e!==undefined){if(e._destroyed)return n;n&&(n.element.removeClass("active focus"),n.meta.type!=="folder"&&n.parentFolder.element.removeClass("focus"));var r=e.meta.type=="folder";return e.element.addClass("active focus"),r||e.parentFolder.element.addClass("focus"),t.title.setTitle(e.meta.title),t.currentFolder(r?e:e.parentFolder),t.currentItem.item=e}return n},currentFolder:function(e){var n=t.currentFolder.folder;return n&&n._destroyed&&(n=t.currentFolder.folder=undefined),e!==undefined?(n&&n.tree.removeClass("active"),e.tree.addClass("active"),t.navigation.setPathway(e.meta.path),t.trigger("folderActivate",[t,e]),t.currentFolder.folder=e):n},scrollTo:function(e){if(e===undefined)return;t.itemGroup().scrollTo(e.element,{duration:500,easing:"swing",offset:{top:t.itemGroup().height()/2*-1}})},"{header} mouseover":function(e,t){t.stopPropagation(),e.addClass("hover")},"{header} mouseout":function(e,t){t.stopPropagation(),e.removeClass("hover")},"{item} click":function(e,n){n.stopPropagation();var r=e.data("item");if(r.meta.type=="folder"&&t.place.id=="flickr")return;r.setLayout(),t.activateItem(r)},"{self} itemActivate":function(e,n,r,i){t.title.setTitle(i.meta.title)},createTreeItem:function(e){var n=t.view.treeItem().data("item",e);return n.find(".treeItemTitle").html(e.meta.title),n},"{treeItem} click":function(e,n){var r=e.data("item");t.focusItem(r)},"{treeToggleButton} click":function(e,n){e.toggleClass("active"),t.content().toggleClass("showBrowserTree"),setTimeout(t.setLayout,500)},"{tileViewButton} click":function(e,n){e.addClass("active").siblings().removeClass("active"),t.viewMode("tile")},"{listViewButton} click":function(e,n){e.addClass("active").siblings().removeClass("active"),t.viewMode("list")},"{itemGroup} scroll":function(e,n){t.setItemLayout()},"{dashboardButton} click":function(e,n){t.media.dashboard.media.hideManager()},viewMode:function(e){var n=t.viewMode.mode;n||(n=t.viewMode.mode=t.options.viewMode);if(e!==undefined){var r=t.itemGroup();r.removeClass("view-"+n).addClass("view-"+e),t.viewMode.mode=n=e,t.setLayout();var i=t.currentItem();i!==undefined&&t.scrollTo(i)}return n},setItemStyle:function(){var n=t.setLayout.seed;if(t.setItemStyle.seed===n)return;t.setItemStyle.seed=n;var r=t.viewMode(),i,s,o={},u=e("<div>").prependTo(t.itemGroup()),a=u.width();u.remove();switch(r){case"tile":var f=128,l=Math.floor(a/f);i=Math.floor(a/l),s=i,itemTitleWidth=i-24,itemTitleLeft=(i-itemTitleWidth)/2,o["#MediaManager .browser .browserItemGroup.view-tile .browserItem"]="width: "+i+"px; height: "+s+"px;",o["html #MediaManager .browser .browserItemGroup.view-tile .browserItem.item-type-folder"]="width: auto !important; height: auto !important;",o["#MediaManager .browser .browserItemGroup.view-tile .browserItem .itemTitle"]="width: "+itemTitleWidth+"px; left: "+itemTitleLeft+"px;",o["html #MediaManager .browser .browserItemGroup.view-tile .browserItem.item-type-folder .folderHeader .itemTitle"]="width: auto !important; height: auto !important;";break;case"list":i="auto",s="auto",o["#MediaManager .browser .browserItemGroup.view-list .browserItem"]="width: "+i+"px; height: "+s+"px;",o["html #MediaManager .browser .browserItemGroup.view-list .browserItem.item-type-folder"]="width: auto !important; height: auto !important;"}var c="";e.each(o,function(e,t){c+=e+"{"+t+"}\n"}),e(document).ready(function(){var e=document.getElementsByTagName("head")[0];if(t.itemStyle)try{e.removeChild(t.itemStyle)}catch(n){}t.itemStyle=document.createElement("style"),t.itemStyle.type="text/css",t.itemStyle.styleSheet?t.itemStyle.styleSheet.cssText=c:t.itemStyle.appendChild(document.createTextNode(c)),e.appendChild(t.itemStyle)})},setItemLayout:function(){t.setItemStyle();var e=t.item(":not(.item-type-folder)").filter(":visible");if(e.length<1)return;var n=t.itemGroup().offset(),r,i,s=e.length,o=1;if(e.length<1)return;while(Math.abs(s-o)>1){r=e.eq(o-1),i=r.offset();var u=i.top-n.top+r.outerHeight();u<0?o=Math.ceil((s+o)/2):(s=o,o=Math.ceil(s/2))}var a=e.eq(o-1).offset().top;for(;;){if(o<0)break;if(e.eq(o-1).offset().top!=a)break;o--}var f=3;o-=f,o<0&&(o=0);var s=0,l=!1;for(;;){if(o>e.length-1)break;var r=e.eq(o).controller(),c=r.isVisible();if(s>f&&!c&&l)break;r.setLayout(),c&&(l=!0),o++,s++}},tasks:[],threads:0,threadLimit:8,addTask:function(e){t.tasks.push(e),t.runTask()},runTask:function(){if(t.tasks.length>0&&t.threads<t.threadLimit){t.threads++;var n=t.tasks.shift(),r=e.Deferred();n.apply(r),r.always(function(){t.threads--,t.runTask()}),t.runTask()}}}}),t.resolve()})});