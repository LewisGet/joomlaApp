EasyBlog.module("media/browser.item",function(e){var t=this;EasyBlog.Controller("Media.Browser.Item",{defaultOptions:{iconDelay:500,"{itemTitle}":".itemTitle","{itemIcon}":".itemIcon",hasCustomHandler:["folder"]}},function(t){return{initialization:e.Deferred(),handlerInitialization:e.Deferred(),init:function(){t.element.data("item",t).addClass("item-type-"+t.meta.type),t.setTitle(),t.createHandler()},createHandler:function(){if(e.inArray(t.meta.type,t.options.hasCustomHandler)<0){t.handlerInitialization.resolve();return}var n=EasyBlog.Controller.Media.Browser.Item[e.String.capitalize(t.meta.type)];if(n===undefined){EasyBlog.require().script("media/browser.item."+t.meta.type).done(function(){t.createHandler()});return}t.handler=new n(t.element,{controller:{media:t.media,place:t.place,browser:t.browser,item:t}}),t.handlerInitialization.resolve()},activate:function(){t.panel===undefined&&(t.panel=t.place.panels.createPanel(t)),t.place.panels.activatePanel(t.panel.id)},remove:function(){try{t.handler&&(t.handler._destroyed||t.handler.destroy()),t.element&&t.element.remove()}catch(e){}},isVisible:function(){var e=t.browser.itemGroup(),n=t.element,r=n.outerHeight(),i=n.offset().top,s=i+r,o=e.offset().top,u=o+e.height();return!(i<o&&s<o||i>u&&s>u)},setLayout:function(n){if(t.meta.type=="folder")return;if(t.handler&&e.isFunction(t.handler.setLayout))return t.handler.setLayout();t.setIcon()},setTitle:function(n){if(t.handler&&e.isFunction(t.handler.setTitle))return t.handler.setTitle(n);t.itemTitle().html(n||t.meta.title)},setIcon:function(){if(t.setIcon.loading)return;if(t.meta.icon===undefined||t._destroyed)return;if(t.setIcon.loaded){t.setIconLayout();return}t.setIcon.loading=!0,t.browser.addTask(function(){var e=this,n=t.itemIcon();if(!t.isVisible())t.setIcon.loading=!1,e.reject();else{var r=t.meta.icon.url;t.setIcon.useNaturalUrl||t.browser.place.id!=="jomsocial"&&t.browser.place.id!=="flickr"&&t.meta.type=="image"&&(r=EasyBlog.baseUrl+"&view=media&layout=getIconImage&place="+encodeURIComponent(t.browser.place.id)+"&path="+encodeURIComponent(t.meta.path)+"&format=image&tmpl=component"),n.css({opacity:0}).load(function(){t.setIcon.loaded=!0,t.setIcon.loading=!1,e.resolve(),t.setLayout()}).error(function(){t.setIcon.loaded=!1,t.setIcon.loading=!1,e.reject(),t.setIcon.triedNaturalUrl||(t.setIcon.useNaturalUrl=!0,t.setIcon.triedNaturalUrl=!0,t.setIcon())}).attr("src",r)}})},setIconLayout:function(){var e=t.browser.viewMode(),n=t.itemIcon(),r=t.itemTitle();switch(e){case"list":var i=parseInt(n.css("maxWidth")),s=parseInt(n.css("maxHeight"));n.css({top:(s-n.height())/2,left:(i-n.width())/2,opacity:1});break;case"tile":var o=24,i=t.element.width(),s=t.element.height()-r.height(),u=t.resizeWithin(n.width(),n.height(),i-o,s-o);n.css({width:u.width,height:u.height,top:(s-u.height)/2,left:(i-u.width)/2,opacity:1})}},resizeWithin:function(e,t,n,r){var i=e,s=t,o=n/e;i=e*o,s=t*o;if(s>r){var o=r/t;i=e*o,s=t*o}return{width:i,height:s}}}}),t.resolve()});