EasyBlog.module("media/panel.image",function(e){var t=this;EasyBlog.require().library("ui/position").view("media/panel.image","media/panel.image.variation").done(function(){EasyBlog.Controller("Media.Panel.Image",{defaultOptions:{view:{content:"media/panel.image",variation:"media/panel.image.variation"},defaultVariation:"thumbnail",defaultImageZoomVariation:"original","{header}":".panelHeader","{body}":".panelBody","{footer}":".panelFooter","{footerText}":".footerText","{insertItemButton}":".insertItemButton","{insertItemDetail}":".insertItemDetail","{imagePreview}":".imagePreview","{imageZoomButton}":".imageZoomButton","{imageVariationList}":".imageVariationList","{imageVariations}":".imageVariations","{imageVariation}":".imageVariation","{imageVariationForm}":".imageVariationForm","{addVariationButton}":".addVariationButton","{backVariationButton}":".backVariationButton","{createVariationButton}":".createVariationButton","{removeVariationButton}":".removeVariationButton","{newVariationName}":".newVariationName","{newVariationWidth}":".newVariationWidth","{newVariationHeight}":".newVariationHeight","{newVariationRatio}":".newVariationRatio","{imageVariationMessage}":".imageVariationMessage",variationNameFilter:RegExp("[^a-zA-Z0-9]","g"),"{imageZoomOption}":".imageZoomOption","{imageZoomLargeImageSelection}":".imageZoomLargeImageSelection","{imageZoomLargeImageOption}":".imageZoomLargeImageSelection option","{imageCaptionOption}":".imageCaptionOption","{imageCaption}":".imageCaption","{imageEnforceDimensionOption}":".imageEnforceDimensionOption","{imageEnforceWidth}":".imageEnforceWidth","{imageEnforceHeight}":".imageEnforceHeight","{itemFilesize}":".itemFilesize","{itemMime}":".itemMime","{itemCreationDate}":".itemCreationDate","{itemUrl}":".itemUrl"}},function(t){return{init:function(){var e=t.view.content({meta:t.item.meta});t.element.append(e),t.setLayout(),t.previewImage(),t.loadVariations();var n=t.imageCaptionOption();t._bind(n,"change",function(e){n.parent(".field").toggleClass("hide-field-content",!n.is(":checked"))});var r=t.imageEnforceDimensionOption();t._bind(r,"change",function(e){return r.parent(".field").toggleClass("hide-field-content",!r.is(":checked")),t.imageEnforceWidth().trigger("keyup"),arguments.callee}())},setLayout:function(){t.place.acl().canCreateVariation&&t.addVariationButton().show()},"{insertItemButton} click":function(){var n=t.media.dashboard,r=t.currentVariation();if(!n)return;var i=e(new Image);i.attr({src:r.url,alt:r.title,width:r.width,height:r.height,title:t.item.meta.title});var s;t.imageCaptionOption().is(":checked")&&(s=t.imageCaption().val(),i.addClass("easyblog-image-caption").attr({title:s||t.item.meta.title})),t.imageEnforceDimensionOption().is(":checked")&&(t.imageEnforceWidth().trigger("keyup"),i.attr({width:t.imageEnforceWidth().val(),height:t.imageEnforceHeight().val()}));if(t.imageZoomOption().is(":checked")){var o=t.imageZoomLargeImageOption(":selected").data("variation");i=e("<a>").addClass("easyblog-thumb-preview").attr({href:o.url,title:s||t.item.meta.title}).html(i)}n.editor.insert(i.toHTML()),t.media.insertRecentActivity(t.item.meta)},currentVariation:function(n){return e.isPlainObject(n)&&(t.currentVariation.variation=n,t.insertItemDetail().html(e.String.capitalize(n.name)+(e.isNumeric(n.width)&&e.isNumeric(n.height)?" "+n.width+"x"+n.height:"")),t.footerText().html(n.filesize),t.itemFilesize().html(n.filesize),t.itemMime().html(n.mime),t.itemCreationDate().html(n.creationDate),t.itemUrl().html(n.url)),t.currentVariation.variation},loadVariations:function(){EasyBlog.ajax("site.views.media.listItems",{place:t.place.id,path:t.item.meta.path,variation:"1"},{beforeSend:function(){t.imageVariations().empty().addClass("busy")},success:function(n){e.extend(t.item.meta,n),t.populateImageVariations()},error:function(){t.loadVariations.count===undefined&&(t.loadVariations.count=0),t.loadVariations.count<3&&(t.loadVariations.count++,t.loadVariations())},complete:function(){t.imageVariations().removeClass("busy");var e=t.imageZoomOption();t._bind(e,"change",function(t){return e.parent(".field").toggleClass("hide-field-content",!e.is(":checked")),arguments.callee}())}})},addVariation:function(n){e.isObject(n)&&t.item.meta.variations.push(n)},addImageVariation:function(n){var r=t.view.variation({variation:n});r.data("variation",n).appendTo(t.imageVariations()),n.canDelete||r.addClass("locked");var i=e.String.capitalize(n.name),s=e("<option>").val(i).html(i).data("variation",n);return n.name==t.options.defaultImageZoomVariation&&s.attr("selected",!0),t.imageZoomLargeImageSelection().append(s),r},populateImageVariations:function(){var n=!1;e.each(t.item.meta.variations,function(e,r){if(r.name=="icon")return;var i=t.addImageVariation(r);r["default"]!==undefined&&(i.addClass("default").click(),n=!0)}),n||t.imageVariation(":first").click()},"{imageVariation} click":function(e){var n=e.data("variation");t.imageVariation().removeClass("active"),e.addClass("active"),t.removeVariationButton().toggle(n.canDelete),t.currentVariation(n)},nextVariationName:function(n){var r=!1,n=e.trim(n.toLowerCase());return e.each(t.item.meta.variations,function(t,i){if(n==i.name.toLowerCase()){r=!0;var s=n.substr(-1,1);return n=e.isNumeric(s)?n.substr(0,n.length-1)+(parseInt(s,10)+1):n+1,!1}}),r?t.nextVariationName(n):n},"{addVariationButton} click":function(){var n=t.currentVariation(),r=e.String.capitalize(t.nextVariationName(n.name));t.imageVariationList().hide(),t.newVariationName().data("default",r).val(r).select(),t.newVariationWidth().data("default",n.width).val(n.width),t.newVariationHeight().data("default",n.height).val(n.height),t.imageVariationForm().show()},"{newVariationRatio} click":function(e){e.toggleClass("locked"),e.hasClass("locked")&&t.newVariationWidth().keyup()},sanitizeVariationName:function(n){var r=t.newVariationName(),i=r.val().replace(t.options.variationNameFilter,"");n&&(i=t.nextVariationName(i),r.val(e.String.capitalize(i)))},"{newVariationName} keyup":function(e){t.sanitizeVariationName()},"{newVariationName} blur":function(e){t.sanitizeVariationName(!0)},"[{newVariationWidth}, {newVariationHeight}] keyup":function(n,r){var i=e.trim(n.val()),s=t.newVariationRatio().is(".locked");if(i==""){s&&(t.newVariationWidth().val(""),t.newVariationHeight().val(""));return}var i=i.replace(RegExp("[^0-9]","g"),""),o=n.data("default"),i=i||o;n.val(i);if(!s||r.keyCode==9)return;var u;i==o?u=1:u=o/(parseInt(i,10)||0);var a=t.newVariationWidth(),f=t.newVariationHeight();n[0]==a[0]&&f.val(Math.floor(f.data("default")/u)),n[0]==f[0]&&a.val(Math.floor(a.data("default")/u))},"{backVariationButton} click":function(){t.imageVariationForm().hide(),t.imageVariationList().show()},"{createVariationButton} click":function(){EasyBlog.ajax("site.views.media.createVariation",{path:t.item.meta.path,place:t.place.id,name:t.newVariationName().val(),width:t.newVariationWidth().val(),height:t.newVariationHeight().val()},{success:function(n){var r=t.view.variation({variation:n}).data("variation",n);t.item.meta.variations.push(n),t.imageVariations().prepend(r),e(r).click(),t.backVariationButton().click()},fail:function(e){t.imageVariationMessage().html(e)}})},"{removeVariationButton} click":function(){var e=t.imageVariation(".active"),n=e.data("variation");n.canDelete&&EasyBlog.ajax("site.views.media.deleteVariation",{fromPath:t.item.meta.path,place:t.place.id,name:n.name},{beforeSend:function(){e.addClass("busy")},success:function(){e.slideUp(function(){e.remove()}),t.imageVariation(".default").click()},fail:function(e){try{console.log(e)}catch(t){}},complete:function(){e.removeClass("busy")}})},resizeWithin:function(e,t,n,r){var i=e,s=t;if(i>n){var o=n/e;i=e*o,s=t*o}if(s>r){var o=r/t;i=e*o,s=t*o}return{width:i,height:s}},preloadImage:function(n,r){var i=e(new Image);return i.load(function(){i.css({position:"absolute",left:"-9999px"}).appendTo("body"),r&&r.apply(t,[i.width(),i.height()]),i.remove()}).attr("src",n),i},previewImage:function(){var e=t.imagePreview();e.addClass("busy"),t.preloadImage(t.item.meta.thumbnail.url,function(n,r){t.imageEnforceWidth().data("default",n),t.imageEnforceHeight().data("default",r),t.imageEnforceWidth().trigger("keyup");var i=e.width(),s=e.height(),o=t.resizeWithin(n,r,i,s);e.animate({opacity:0},function(){e.removeClass("busy").css({width:o.width,height:o.height,top:(s-o.height)/2,left:(i-o.width)/2}).load(function(){e.animate({opacity:1})}).attr({src:t.item.meta.thumbnail.url})})})},zoomImage:function(){var n=t.currentVariation();e.dialog({title:e.String.capitalize(n.name),content:e.Deferred(),showOverlay:!1,body:{css:{padding:0}}}),t.preloadImage(n.url,function(t,r){var i=e(new Image);i.attr({src:n.url,width:t,height:r}),e.dialog({content:i.toHTML(),width:t,height:r,body:{css:{minWidth:0,minHeight:0}}})})},canHideZoomButton:!1,zoomButtonVisible:!1,"[{imagePreview}, {imageZoomButton}] mouseover":function(){if(t.imagePreview().is(".busy"))return;if(t.zoomButtonVisible&&t.canHideZoomButton){t.canHideZoomButton=!1;return}t.zoomButtonVisible=!0,t.imageZoomButton().css({opacity:0}).show().position({my:"right top",at:"right top",offset:"-10px 10px",of:t.imagePreview()}).css({left:"-=10px"}).animate({opacity:1,left:"+=10px"})},"[{imagePreview}, {imageZoomButton}] mouseout":function(){t.canHideZoomButton=!0,setTimeout(function(){t.canHideZoomButton&&(t.imageZoomButton().hide(),t.zoomButtonVisible=!1)},250)},"[{imagePreview}, {imageZoomButton}] click":function(){t.zoomImage()},"[{imageEnforceWidth}, {imageEnforceHeight}] keyup":function(n,r){var i=e.trim(n.val());if(i==""){t.imageEnforceWidth().val(""),t.imageEnforceHeight().val("");return}var i=i.replace(RegExp("[^0-9]","g"),""),s=n.data("default")||n.attr("initial"),i=i||s;n.val(i);if(r.keyCode==9)return;var o;i==s?o=1:o=s/(parseInt(i,10)||0);var u=t.imageEnforceWidth(),a=t.imageEnforceHeight();n[0]==u[0]&&a.val(Math.floor((a.data("default")||a.attr("initial"))/o)),n[0]==a[0]&&u.val(Math.floor((u.data("default")||u.attr("initial"))/o))},"{imageCaptionOption} mouseup":function(){setTimeout(function(){t.imageCaption().focus()[0].select()},1)}}}),t.resolve()})});